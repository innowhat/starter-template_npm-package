name: CI Pipeline

on:
    push:
        branches: ['**']
        tags-ignore: ['v*']
    pull_request:
        types: [opened, synchronize, reopened]
        branches: [main]

# Add concurrency control to cancel outdated runs
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: 🔍 Code Quality & Linting
        runs-on: ubuntu-22.04

        if: >
            (github.event_name == 'push' && github.actor != 'github-actions[bot]') ||
            (github.event_name == 'pull_request' && github.actor != 'github-actions[bot]')

        strategy:
            matrix:
                node-version: [18.x, 20.x, 22.x]

        steps:
            - name: 📦 Checkout repository
              uses: actions/checkout@v4

            - name: 🟢 Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  always-auth: false

            - name: 📥 Install dependencies
              run: npm ci

            - name: 🔍 Run ESLint
              run: npm run lint

    tests:
        name: 🧪 Test Suite
        runs-on: ubuntu-22.04
        needs: lint

        if: >
            (github.event_name == 'push' && github.actor != 'github-actions[bot]') ||
            (github.event_name == 'pull_request' && github.actor != 'github-actions[bot]')

        strategy:
            matrix:
                node-version: [18.x, 20.x, 22.x]
            # Added: Don't cancel other matrix jobs if one fails
            fail-fast: false

        steps:
            - name: 📦 Checkout repository
              uses: actions/checkout@v4

            - name: 🟢 Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  cache: 'npm'
                  always-auth: false

            - name: 📥 Install dependencies
              run: npm ci

            - name: 🧪 Run test suite
              run: npm run test:ci

    build:
        name: 🏗️ Build Verification
        runs-on: ubuntu-22.04
        needs: [lint, tests]

        if: >
            (github.event_name == 'push' && github.actor != 'github-actions[bot]') ||
            (github.event_name == 'pull_request' && github.actor != 'github-actions[bot]')

        strategy:
            matrix:
                node-version: [18.x, 20.x, 22.x]
                architecture: [x64]

        steps:
            - name: 📦 Checkout repository
              uses: actions/checkout@v4

            - name: 🟢 Setup Node.js ${{ matrix.node-version }} (${{ matrix.architecture }})
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.node-version }}
                  architecture: ${{ matrix.architecture }}
                  cache: 'npm'

            - name: 📥 Install dependencies
              run: npm ci

            - name: 🏗️ Build project
              run: npm run build

            # Added: Basic verification that build worked
            - name: ✅ Verify build output
              run: test -d dist || (echo "Build failed - no dist directory" && exit 1)
